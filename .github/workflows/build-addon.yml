name: Build Blender Add-on

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  package:
    runs-on: ubuntu-latest
    env:
      BLENDER_VERSION: "5.0.0"
      BLENDER_RELEASE_URL: "https://download.blender.org/release/Blender5.0/blender-5.0.0-linux-x64.tar.xz"
      BLENDER_ARCHIVE: "blender-5.0.0-linux-x64.tar.xz"
      BLENDER_DIR: "blender-5.0.0-linux-x64"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract manifest metadata
        id: manifest
        run: |
          python -c "import tomllib, pathlib; data = tomllib.loads(pathlib.Path('blender_manifest.toml').read_text(encoding='utf-8')); print('addon_id=' + data['id']); print('version=' + data['version'])" | tee -a "$GITHUB_OUTPUT"

      - name: Determine archive path
        id: archive
        run: echo "path=dist/${{ steps.manifest.outputs.addon_id }}-${{ steps.manifest.outputs.version }}.zip" >> "$GITHUB_OUTPUT"

      - name: Install Blender CLI
        run: |
          curl -L "$BLENDER_RELEASE_URL" -o "$BLENDER_ARCHIVE"
          tar -xf "$BLENDER_ARCHIVE"

      - name: Build and validate package
        run: |
          mkdir -p dist
          "./$BLENDER_DIR/blender" --command extension build --output-dir dist
          "./$BLENDER_DIR/blender" --command extension validate "${{ steps.archive.outputs.path }}"

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.manifest.outputs.addon_id }}-${{ steps.manifest.outputs.version }}
          path: ${{ steps.archive.outputs.path }}
          if-no-files-found: error
