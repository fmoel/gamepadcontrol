name: Build Blender Add-on

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - closed

permissions:
  contents: read

jobs:
  package:
    if: github.event_name != 'pull_request' || github.event.action != 'closed'
    runs-on: ubuntu-latest
    env:
      BLENDER_VERSION: "5.0.0"
      BLENDER_RELEASE_URL: "https://download.blender.org/release/Blender5.0/blender-5.0.0-linux-x64.tar.xz"
      BLENDER_ARCHIVE: "blender-5.0.0-linux-x64.tar.xz"
      BLENDER_DIR_NAME: "blender-5.0.0-linux-x64"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure build paths
        run: |
          echo "BUILD_DIR=$RUNNER_TEMP/addon_zip" >> "$GITHUB_ENV"
          echo "OUTPUT_DIR=$RUNNER_TEMP/addon_dist" >> "$GITHUB_ENV"

      - name: Extract manifest metadata
        id: manifest
        run: |
          python -c "import tomllib, pathlib; data = tomllib.loads(pathlib.Path('blender_manifest.toml').read_text(encoding='utf-8')); print('addon_id=' + data['id']); print('version=' + data['version'])" | tee -a "$GITHUB_OUTPUT"

      - name: Determine artifact name
        id: artifact-name
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "name=${{ steps.manifest.outputs.addon_id }}-${{ steps.manifest.outputs.version }}-pr-${{ github.event.number }}" >> "$GITHUB_OUTPUT"
          else
            echo "name=${{ steps.manifest.outputs.addon_id }}-${{ steps.manifest.outputs.version }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Determine archive path
        id: archive
        run: echo "path=$BUILD_DIR/${{ steps.manifest.outputs.addon_id }}-${{ steps.manifest.outputs.version }}.zip" >> "$GITHUB_OUTPUT"

      - name: Install Blender CLI
        run: |
          curl -L "$BLENDER_RELEASE_URL" -o "$RUNNER_TEMP/$BLENDER_ARCHIVE"
          tar -xf "$RUNNER_TEMP/$BLENDER_ARCHIVE" -C "$RUNNER_TEMP"
          echo "BLENDER_BIN=$RUNNER_TEMP/$BLENDER_DIR_NAME/blender" >> "$GITHUB_ENV"

      - name: Build package
        run: |
          mkdir -p "$BUILD_DIR"
          "$BLENDER_BIN" --command extension build --output-dir "$BUILD_DIR"

      - name: Validate package metadata
        run: |
          "$BLENDER_BIN" --command extension validate "${{ steps.archive.outputs.path }}"

      - name: Prepare artifact directory
        run: |
          rm -rf "$OUTPUT_DIR"
          mkdir -p "$OUTPUT_DIR"
          unzip -q "${{ steps.archive.outputs.path }}" -d "$OUTPUT_DIR"

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact-name.outputs.name }}
          path: ${{ env.OUTPUT_DIR }}
          if-no-files-found: error

  cleanup-artifacts:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    permissions:
      actions: write
    steps:
      - name: Remove artifacts for closed PR
        env:
          GH_TOKEN: ${{ github.token }}
          PR_SUFFIX: -pr-${{ github.event.number }}
          PR_NUMBER: ${{ github.event.number }}
        run: |
          set -euo pipefail
          artifacts=$(gh api repos/${{ github.repository }}/actions/artifacts --paginate | jq -r --arg pr_suffix "$PR_SUFFIX" '.artifacts[] | select(.name | endswith($pr_suffix)) | .id')
          if [ -z "$artifacts" ]; then
            echo "No artifacts to delete for PR #$PR_NUMBER" && exit 0
          fi
          for artifact_id in $artifacts; do
            gh api repos/${{ github.repository }}/actions/artifacts/$artifact_id -X DELETE >/dev/null
            echo "Deleted artifact $artifact_id for PR #$PR_NUMBER"
          done
